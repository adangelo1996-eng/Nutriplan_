<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta id="metaThemeColor" name="theme-color" content="#4a9b7f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>NutriPlan</title>
  <link id="manifest-placeholder" rel="manifest" href="">
  <link id="appleTouchIcon" rel="apple-touch-icon" href="">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
    /* â”€â”€ SIDEBAR DESKTOP â”€â”€ */
    .sidebar-nav {
      display: none;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: var(--sidebar-w, 210px);
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      flex-direction: column;
      padding-top: var(--header-h, 56px);
      z-index: 100;
      overflow-y: auto;
      box-shadow: 2px 0 12px rgba(0,0,0,.06);
    }
    .sidebar-nav .nav-tab {
      flex: none;
      flex-direction: row;
      justify-content: flex-start;
      gap: 12px;
      padding: 13px 20px;
      border-radius: 0;
      font-size: .88em;
      width: 100%;
      color: var(--text-mid);
    }
    .sidebar-nav .nav-tab .nav-icon { font-size: 1.2em; }
    .sidebar-nav .nav-tab .nav-label { font-size: 1em; max-width: none; }
    .sidebar-nav .nav-tab.active {
      background: var(--primary-light);
      color: var(--primary);
      border-left: 3px solid var(--primary);
    }
    .sidebar-nav .nav-tab.active::after { display: none; }

    @media (min-width: 768px) {
      .sidebar-nav { display: flex; }
      .bottom-nav  { display: none !important; }
      .app-main    { margin-left: var(--sidebar-w, 210px) !important; margin-bottom: 0 !important; }
    }

    /* â”€â”€ MODAL â”€â”€ */
    .modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.45); z-index: 500;
      align-items: center; justify-content: center; padding: 16px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--bg-card); border-radius: var(--radius-lg);
      width: 100%; max-width: 480px; max-height: 90dvh;
      overflow-y: auto; box-shadow: var(--shadow-lg);
      animation: fadeIn .18s ease;
    }
    .modal-content-large { max-width: 600px; }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 18px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--bg-card); z-index: 1;
    }
    .modal-header h3 { font-size: 1em; font-weight: 800; margin: 0; }
    .modal-close {
      background: none; border: none; font-size: 1.1em;
      cursor: pointer; color: var(--text-light); padding: 4px;
      line-height: 1; border-radius: var(--radius-xs);
      transition: background .2s;
    }
    .modal-close:hover { background: var(--border); }
    .modal-body   { padding: 18px; }
    .modal-footer {
      display: flex; gap: 8px; justify-content: flex-end;
      padding: 14px 18px; border-top: 1px solid var(--border);
    }

    /* â”€â”€ STORICO â”€â”€ */
    .storico-list { display: flex; flex-direction: column; gap: 8px; }
    .storico-day  { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
    .storico-day-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; cursor: pointer; gap: 8px;
    }
    .storico-day-header:hover { background: var(--bg-light); }
    .storico-day-label  { font-weight: 800; font-size: .9em; }
    .storico-day-count  { font-size: .78em; color: var(--text-light); font-weight: 600; }
    .storico-day-toggle { color: var(--text-light); font-size: .9em; }
    .storico-day-detail { padding: 0 14px 12px; }
    .storico-meal-block { margin-bottom: 10px; }
    .storico-meal-title { font-size: .76em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 6px; }
    .storico-item       { display: flex; align-items: center; justify-content: space-between; font-size: .84em; padding: 4px 0; border-bottom: 1px solid var(--border); }
    .storico-item:last-child { border-bottom: none; }
    .storico-item-qty   { color: var(--text-light); font-size: .9em; }

    /* â”€â”€ SPESA â”€â”€ */
    .spesa-header-row   { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
    .spesa-title        { font-size: 1.05em; font-weight: 800; }
    .spesa-subtitle     { font-size: .76em; color: var(--text-light); margin-top: 2px; }
    .spesa-section-title{ font-size: .74em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: .06em; margin: 14px 0 6px; }
    .spesa-progress-row { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
    .spesa-progress-bar { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .spesa-progress-fill{ height: 100%; background: linear-gradient(90deg, var(--primary), var(--success, #3aaa6e)); border-radius: 3px; transition: width .5s; }
    .spesa-progress-label{ font-size: .78em; font-weight: 700; color: var(--text-mid); white-space: nowrap; }
    .spesa-list         { display: flex; flex-direction: column; gap: 5px; }
    .spesa-item         { display: flex; align-items: center; gap: 10px; background: var(--bg-card); border-radius: var(--radius-sm); padding: 11px 12px; border: 1.5px solid var(--border); cursor: pointer; transition: all .2s; }
    .spesa-item:hover   { background: var(--bg-light); }
    .spesa-item.done    { opacity: .6; }
    .spesa-item-check   { font-size: 1.1em; flex-shrink: 0; }
    .spesa-item-info    { flex: 1; min-width: 0; }
    .spesa-item-name    { font-size: .88em; font-weight: 700; }
    .spesa-item.done .spesa-item-name { text-decoration: line-through; color: var(--text-light); }
    .spesa-item-qty     { font-size: .76em; color: var(--text-light); margin-top: 2px; }
    .spesa-item-actions { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
    .spesa-badge-auto   { font-size: .65em; font-weight: 800; background: var(--primary-light); color: var(--primary); padding: 2px 6px; border-radius: 10px; }
    .spesa-badge-manual { font-size: .65em; font-weight: 800; background: var(--bg2, #e6ede9); color: var(--text-light); padding: 2px 6px; border-radius: 10px; }
    .spesa-delete-btn   { background: none; border: none; cursor: pointer; font-size: .85em; color: var(--text-light); padding: 3px; border-radius: var(--radius-xs); }
    .spesa-delete-btn:hover { color: var(--danger, #e05252); background: var(--bg-light); }
    .spesa-add-row      { display: flex; gap: 8px; align-items: center; }

    /* â”€â”€ PROFILO â”€â”€ */
    .profilo-section    { background: var(--bg-card); border-radius: var(--radius-lg); padding: 18px; margin-bottom: 14px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .profilo-title      { font-size: .95em; font-weight: 800; margin: 0 0 14px; }
    .profilo-user-card  { display: flex; align-items: center; gap: 14px; }
    .profilo-avatar     { width: 56px; height: 56px; border-radius: 50%; border: 3px solid var(--primary); }
    .profilo-avatar-placeholder { width: 56px; height: 56px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 1.6em; flex-shrink: 0; }
    .profilo-user-name  { font-weight: 800; font-size: 1em; }
    .profilo-user-email { font-size: .78em; color: var(--text-light); margin-top: 2px; }
    .profilo-sync-info  { font-size: .74em; color: var(--primary); margin-top: 4px; font-weight: 700; }
    .profilo-noauth-card{ text-align: center; padding: 20px 10px; }
    .profilo-meal-section { background: var(--bg-light); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 8px; border: 1px solid var(--border); }
    .profilo-meal-header  { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .profilo-meal-title   { font-size: .82em; font-weight: 800; }
    .profilo-empty-meal   { font-size: .8em; color: var(--text-light); font-style: italic; }
    .profilo-item-row     { display: flex; gap: 6px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }
    .profilo-item-name    { flex: 2; min-width: 100px; }
    .edit-item-row        { display: flex; gap: 6px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }

    /* â”€â”€ STATS â”€â”€ */
    .stats-grid         { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap: 10px; margin-bottom: 20px; }
    .stat-card          { background: var(--bg-card); border-radius: var(--radius); padding: 16px 12px; text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .stat-card-icon     { font-size: 1.8em; margin-bottom: 6px; }
    .stat-card-value    { font-size: 1.4em; font-weight: 800; color: var(--primary); }
    .stat-card-label    { font-size: .72em; color: var(--text-light); margin-top: 3px; font-weight: 700; }

    /* â”€â”€ LIMITS â”€â”€ */
    .limit-card         { background: var(--bg-card); border-radius: var(--radius); padding: 14px 12px; text-align: center; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
    .limit-card.warning { border-color: var(--warning, #f0a500); }
    .limit-card.exceeded{ border-color: var(--danger, #e05252); }
    .limit-card-icon    { font-size: 1.6em; margin-bottom: 5px; }
    .limit-card-name    { font-size: .72em; font-weight: 800; color: var(--text-light); margin-bottom: 8px; text-transform: uppercase; letter-spacing: .04em; }
    .limit-progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
    .limit-progress-fill{ height: 100%; background: var(--primary); border-radius: 3px; transition: width .4s; }
    .limit-progress-fill.warning  { background: var(--warning, #f0a500); }
    .limit-progress-fill.exceeded { background: var(--danger, #e05252); }
    .limit-text         { font-size: .76em; font-weight: 800; color: var(--text-mid); }
    .limit-text.warning  { color: var(--warning, #f0a500); }
    .limit-text.exceeded { color: var(--danger, #e05252); }

    /* â”€â”€ EMPTY STATE â”€â”€ */
    .empty-state        { text-align: center; padding: 48px 20px; color: var(--text-light); }
    .empty-state-icon   { font-size: 2.6em; margin-bottom: 12px; }
    .empty-state h3     { font-size: 1em; font-weight: 800; color: var(--text-mid); margin-bottom: 6px; }
    .empty-state p      { font-size: .84em; line-height: 1.6; }

    /* â”€â”€ IOS BANNER â”€â”€ */
    .ios-banner         { display: none; position: fixed; bottom: 80px; left: 16px; right: 16px; background: var(--bg-card); border-radius: var(--radius); padding: 14px 16px; box-shadow: var(--shadow-lg); z-index: 400; border: 1px solid var(--border); }
    .ios-banner.show    { display: flex; align-items: center; gap: 10px; }
    .install-banner     { display: none; position: fixed; top: calc(var(--header-h,56px) + 8px); left: 50%; transform: translateX(-50%); background: var(--bg-card); border-radius: var(--radius); padding: 10px 14px; box-shadow: var(--shadow-lg); z-index: 300; border: 1px solid var(--border); gap: 10px; align-items: center; white-space: nowrap; font-size: .84em; font-weight: 700; }
    .install-banner.show { display: flex; }

    /* â”€â”€ RICETTA FORM ROW â”€â”€ */
    .rf-ing-row { display: flex; gap: 5px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }
    .rf-ing-name { flex: 2; min-width: 100px; }
    .rf-ing-qty  { width: 68px !important; flex: none; }
    .rf-ing-unit { width: 78px !important; flex: none; }
  </style>
</head>
<body>

<!-- ============================================================
     LANDING
     ============================================================ -->
<div id="landingPage">
  <div id="landingLogo"></div>
  <div class="landing-title">NutriPlan</div>
  <div class="landing-sub">Il tuo piano alimentare personale</div>
  <button class="btn btn-primary btn-large" onclick="enterApp()">â–¶ Inizia</button>
</div>

<!-- ============================================================
     APP
     ============================================================ -->
<div id="mainApp">

  <!-- â”€â”€ HEADER â”€â”€ -->
  <header class="app-header">
    <div class="app-inner">
      <div class="header-left">
        <canvas id="headerIcon" width="32" height="32"></canvas>
        <span class="header-title">NutriPlan</span>
      </div>
      <div class="header-right">
        <span id="cloudStatus" class="cloud-status local">ğŸ’¾ Locale</span>
        <button id="loginBtn"
                class="btn-icon-only"
                onclick="signInWithGoogle()"
                title="Accedi con Google">ğŸ”‘</button>
        <button id="logoutBtn"
                class="btn-icon-only"
                onclick="signOut()"
                title="Disconnetti"
                style="display:none">ğŸšª</button>
        <button id="darkToggle"
                class="btn-icon-only"
                onclick="toggleDarkMode()"
                title="Tema">ğŸŒ™</button>
      </div>
    </div>
  </header>

  <!-- â”€â”€ SIDEBAR (desktop) â”€â”€ -->
  <aside class="sidebar-nav">
    <button class="nav-tab active" onclick="showPage('piano',this)">
      <span class="nav-icon">ğŸ </span><span class="nav-label">Piano</span>
    </button>
    <button class="nav-tab" onclick="showPage('dispensa',this)">
      <span class="nav-icon">ğŸ§º</span><span class="nav-label">Dispensa</span>
    </button>
    <button class="nav-tab" onclick="showPage('ricette',this)">
      <span class="nav-icon">ğŸ“–</span><span class="nav-label">Ricette</span>
    </button>
    <button class="nav-tab" onclick="showPage('storico',this)">
      <span class="nav-icon">ğŸ“…</span><span class="nav-label">Storico</span>
    </button>
    <button class="nav-tab" onclick="showPage('spesa',this)">
      <span class="nav-icon">ğŸ›’</span><span class="nav-label">Spesa</span>
    </button>
    <button class="nav-tab" onclick="showPage('statistiche',this)">
      <span class="nav-icon">ğŸ“Š</span><span class="nav-label">Stats</span>
    </button>
    <button class="nav-tab" onclick="showPage('profilo',this)">
      <span class="nav-icon">ğŸ‘¤</span><span class="nav-label">Profilo</span>
    </button>
  </aside>

  <!-- â”€â”€ CONTENUTO â”€â”€ -->
  <main class="app-main">

    <!-- â•â• PIANO â•â• -->
    <div id="pianoPage" class="page active">

      <div class="calendar-wrap">
        <div class="calendar-bar-wrap">
          <div class="calendar-bar" id="calendarBar"></div>
        </div>
        <div class="current-date-label" id="currentDateLabel"></div>
      </div>

      <div class="page-tabs">
        <button class="page-tab active" onclick="showPianoTab('pasto',this)">ğŸ½ Pasto</button>
        <button class="page-tab"        onclick="showPianoTab('frigo',this)">â„ï¸ Frigo</button>
        <button class="page-tab"        onclick="showPianoTab('giorno',this)">ğŸŒ¿ Ingredienti</button>
        <button class="page-tab"        onclick="showPianoTab('limiti',this)">ğŸ“Š Limiti</button>
      </div>

      <!-- TAB PASTO -->
      <div id="pianoTabPasto" class="page-tab-content active">
        <div id="mealProgressWrap"></div>
        <div id="mealSelector" class="meal-selector"></div>
        <div id="mealItemsList"></div>
      </div>

      <!-- TAB FRIGO -->
      <div id="pianoTabFrigo" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">â„ï¸ Ricette con quel che hai</span>
          <button class="btn btn-secondary btn-small" onclick="openSaveFridgeModal()">ğŸ’¾ Salva</button>
        </div>
        <div id="fridgeSuggestions"></div>
        <div class="section-header" style="margin-top:20px">
          <span class="section-title">ğŸ“ Frigo salvati</span>
        </div>
        <div id="savedFridgesContent"></div>
      </div>

      <!-- TAB INGREDIENTI GIORNO -->
      <div id="pianoTabGiorno" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">ğŸŒ¿ Ingredienti del giorno</span>
        </div>
        <div id="dayIngredientsGrid"></div>
      </div>

      <!-- TAB LIMITI -->
      <div id="pianoTabLimiti" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">ğŸ“Š Limiti settimanali</span>
          <button class="btn btn-secondary btn-small" onclick="resetWeek()">ğŸ”„ Reset</button>
        </div>
        <div id="limitsGrid" class="limits-grid"></div>
      </div>

    </div><!-- /pianoPage -->


    <!-- â•â• DISPENSA â•â• -->
    <div id="dispensaPage" class="page">

      <div class="page-tabs">
        <button class="page-tab active" onclick="showDispensaTab('dispensa',this)">ğŸ§º Dispensa</button>
        <button class="page-tab"        onclick="showDispensaTab('frigo',this)">â„ï¸ Frigo</button>
      </div>

      <!-- TAB DISPENSA -->
      <div id="dispensaTabDispensa" class="page-tab-content active">
        <div class="search-bar-row">
          <div class="search-input-wrap">
            <input type="text"
                   id="pantrySearch"
                   class="form-input search-input"
                   placeholder="ğŸ” Cerca ingrediente..."
                   oninput="filterPantry(this.value)"
                   list="ingredientiDatalist">
            <button class="search-clear-btn" onclick="clearPantrySearch()">âœ•</button>
          </div>
          <button class="btn-add-ing" onclick="openCustomIngModal()" title="Aggiungi">ï¼‹</button>
        </div>
        <div id="pantryContent"></div>
      </div>

      <!-- TAB FRIGO -->
      <div id="dispensaTabFrigo" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">â„ï¸ Nel frigo ora</span>
          <button class="btn btn-secondary btn-small" onclick="openSaveFridgeModal()">ğŸ’¾ Salva</button>
        </div>
        <p style="font-size:.8em;color:var(--text-light);margin-bottom:14px;line-height:1.5">
          Il frigo mostra gli ingredienti deperibili presenti in dispensa.
          Si aggiorna quando aggiungi ingredienti o segni acquisti dalla spesa.
        </p>
        <div id="fridgeContent"></div>
        <div class="section-header" style="margin-top:20px">
          <span class="section-title">ğŸ“ Frigo salvati</span>
        </div>
        <div id="savedFridgesContent2"></div>
      </div>

    </div><!-- /dispensaPage -->


    <!-- â•â• RICETTE â•â• -->
    <div id="ricettePage" class="page">

      <div class="page-tabs">
        <button class="page-tab active" onclick="showRicetteTab('catalogo',this)">ğŸ“– Catalogo</button>
        <button class="page-tab"        onclick="showRicetteTab('mie',this)">â­ Le mie</button>
      </div>

      <div id="ricetteTabCatalogo" class="page-tab-content active">
        <input type="text"
               id="ricetteSearch"
               class="form-input"
               placeholder="ğŸ” Cerca ricetta o ingrediente..."
               style="margin-bottom:12px"
               oninput="filterRicette(this.value)"
               list="ingredientiDatalist">
        <div id="ricetteFilterRow" class="ricette-filter-row"></div>
        <div id="ricetteGrid" class="ricette-grid"></div>
      </div>

      <div id="ricetteTabMie" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">â­ Le mie ricette</span>
          <button class="btn btn-primary btn-small" onclick="openRicettaForm()">ï¼‹ Nuova</button>
        </div>
        <div id="customRicetteList"></div>
      </div>

    </div><!-- /ricettePage -->


    <!-- â•â• STORICO â•â• -->
    <div id="storicoPage" class="page">
      <div class="section-header">
        <span class="section-title">ğŸ“… Storico pasti</span>
      </div>
      <div id="storicoContent"></div>
    </div>


    <!-- â•â• SPESA â•â• -->
    <div id="spesaPage" class="page">
      <div id="spesaContent"></div>
    </div>


    <!-- â•â• STATISTICHE â•â• -->
    <div id="statistichePage" class="page">
      <div class="section-header">
        <span class="section-title">ğŸ“Š Statistiche</span>
      </div>
      <div id="statsContent"></div>
    </div>


    <!-- â•â• PROFILO â•â• -->
    <div id="profiloPage" class="page">
      <!-- popolato da renderProfilo() in profilo.js -->
    </div>

  </main>

  <!-- â”€â”€ BOTTOM NAV (mobile) â”€â”€ -->
  <nav class="bottom-nav">
    <div class="app-inner">
      <button class="nav-tab active" onclick="showPage('piano',this)">
        <span class="nav-icon">ğŸ </span><span class="nav-label">Piano</span>
      </button>
      <button class="nav-tab" onclick="showPage('dispensa',this)">
        <span class="nav-icon">ğŸ§º</span><span class="nav-label">Dispensa</span>
      </button>
      <button class="nav-tab" onclick="showPage('ricette',this)">
        <span class="nav-icon">ğŸ“–</span><span class="nav-label">Ricette</span>
      </button>
      <button class="nav-tab" onclick="showPage('storico',this)">
        <span class="nav-icon">ğŸ“…</span><span class="nav-label">Storico</span>
      </button>
      <button class="nav-tab" onclick="showPage('spesa',this)">
        <span class="nav-icon">ğŸ›’</span><span class="nav-label">Spesa</span>
      </button>
      <button class="nav-tab" onclick="showPage('statistiche',this)">
        <span class="nav-icon">ğŸ“Š</span><span class="nav-label">Stats</span>
      </button>
      <button class="nav-tab" onclick="showPage('profilo',this)">
        <span class="nav-icon">ğŸ‘¤</span><span class="nav-label">Profilo</span>
      </button>
    </div>
  </nav>

</div><!-- /mainApp -->


<!-- ============================================================
     MODALI
     ============================================================ -->

<!-- RICETTA DETTAGLIO -->
<div class="modal" id="recipeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="recipeModalTitle">Ricetta</h3>
      <button class="modal-close" onclick="closeRecipeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="recipeModalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeRecipeModal()">Chiudi</button>
      <button class="btn btn-primary"   onclick="applyRecipeToMeal()">âœ… Aggiungi al piano</button>
    </div>
  </div>
</div>

<!-- SALVA FRIGO -->
<div class="modal" id="saveFridgeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ’¾ Salva configurazione frigo</h3>
      <button class="modal-close" onclick="closeSaveFridgeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nome configurazione</label>
        <input type="text" id="fridgeName" class="form-input"
               placeholder="es. Spesa settimanale..."
               onkeypress="if(event.key==='Enter')saveFridge()">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSaveFridgeModal()">Annulla</button>
      <button class="btn btn-primary"   onclick="saveFridge()">ğŸ’¾ Salva</button>
    </div>
  </div>
</div>

<!-- AGGIUNGI INGREDIENTE CUSTOM -->
<div class="modal" id="customIngModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>â• Aggiungi ingrediente</h3>
      <button class="modal-close" onclick="closeCustomIngModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nome <span style="color:var(--danger,#e05252)">*</span></label>
        <input type="text" id="customIngName" class="form-input"
               placeholder="es. Tofu, Avena..."
               list="ingredientiDatalist"
               onkeypress="if(event.key==='Enter')addCustomIngredient()">
      </div>
      <div class="form-group">
        <label>Categoria <span style="color:var(--danger,#e05252)">*</span></label>
        <select id="customIngCategory" class="form-input">
          <option value="">-- Seleziona categoria --</option>
          <option value="ğŸ¥© Carne e Pesce">ğŸ¥© Carne e Pesce</option>
          <option value="ğŸ¥› Latticini e Uova">ğŸ¥› Latticini e Uova</option>
          <option value="ğŸŒ¾ Cereali e Legumi">ğŸŒ¾ Cereali e Legumi</option>
          <option value="ğŸ¥¦ Verdure">ğŸ¥¦ Verdure</option>
          <option value="ğŸ Frutta">ğŸ Frutta</option>
          <option value="ğŸ¥‘ Grassi e Condimenti">ğŸ¥‘ Grassi e Condimenti</option>
          <option value="ğŸ« Dolci e Snack">ğŸ« Dolci e Snack</option>
          <option value="ğŸ§‚ Cucina">ğŸ§‚ Cucina</option>
        </select>
      </div>
      <div class="form-group">
        <label>UnitÃ  di misura</label>
        <select id="customIngUnit" class="form-input">
          <option value="g">g</option>
          <option value="ml">ml</option>
          <option value="pz">pz</option>
          <option value="fette">fette</option>
          <option value="cucchiai">cucchiai</option>
          <option value="cucchiaini">cucchiaini</option>
          <option value="porzione">porzione</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCustomIngModal()">Annulla</button>
      <button class="btn btn-primary"   onclick="addCustomIngredient()">â• Aggiungi</button>
    </div>
  </div>
</div>

<!-- NUOVA RICETTA -->
<div class="modal" id="ricettaFormModal">
  <div class="modal-content modal-content-large">
    <div class="modal-header">
      <h3 id="ricettaFormTitle">â­ Nuova ricetta</h3>
      <button class="modal-close" onclick="closeRicettaForm()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nome <span style="color:var(--danger,#e05252)">*</span></label>
        <input type="text" id="rfNome" class="form-input" placeholder="es. Pasta al pesto...">
      </div>
      <div class="form-group">
        <label>Pasto ideale</label>
        <select id="rfPasto" class="form-input">
          <option value="colazione">â˜€ï¸ Colazione</option>
          <option value="spuntino">ğŸ Spuntino</option>
          <option value="pranzo" selected>ğŸ½ Pranzo</option>
          <option value="merenda">ğŸ¥ª Merenda</option>
          <option value="cena">ğŸŒ™ Cena</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ingredienti</label>
        <div id="rfIngList"></div>
        <button class="btn btn-secondary btn-small" style="margin-top:6px" onclick="addRfIngRow()">ï¼‹ Ingrediente</button>
      </div>
      <div class="form-group">
        <label>Preparazione</label>
        <textarea id="rfPrep" class="form-input form-textarea"
                  placeholder="Descrivi i passaggi..."></textarea>
      </div>
      <input type="hidden" id="rfEditIdx" value="">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeRicettaForm()">Annulla</button>
      <button class="btn btn-primary"   onclick="saveCustomRicetta()">ğŸ’¾ Salva ricetta</button>
    </div>
  </div>
</div>

<!-- SPESA: QUANTITÃ€ ACQUISTATA -->
<div class="modal" id="spesaItemModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="spesaItemModalTitle">âœ… QuantitÃ  acquistata</h3>
      <button class="modal-close" onclick="closeSpesaItemModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p style="color:var(--text-mid);font-size:.88em;margin-bottom:16px;line-height:1.6">
        Inserisci la quantitÃ  acquistata per aggiornare automaticamente dispensa e frigo.
      </p>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="number" id="spesaItemQty" class="form-input"
               placeholder="QuantitÃ " min="0" step="any" style="flex:1"
               onkeypress="if(event.key==='Enter')confirmSpesaQuantity()">
        <select id="spesaItemUnit" class="form-input" style="width:90px;flex:none">
          <option value="g">g</option>
          <option value="ml">ml</option>
          <option value="pz">pz</option>
          <option value="fette">fette</option>
          <option value="cucchiai">cucchiai</option>
          <option value="cucchiaini">cucchiaini</option>
          <option value="porzione">porzione</option>
          <option value="kg">kg</option>
          <option value="l">l</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSpesaItemModal()">Salta</button>
      <button class="btn btn-primary"   onclick="confirmSpesaQuantity()">âœ… Conferma</button>
    </div>
  </div>
</div>

<!-- iOS BANNER -->
<div class="ios-banner" id="iosBanner">
  <span>ğŸ“² Installa NutriPlan</span>
  <span style="flex:1;font-size:.8em;color:var(--text-light)">Tocca â¬†ï¸ poi "Aggiungi a schermata Home"</span>
  <button class="btn btn-secondary btn-small" onclick="closeIosBanner()">âœ•</button>
</div>

<!-- INSTALL BANNER (PWA Android/Chrome) -->
<div class="install-banner" id="installBanner">
  <span>ğŸ“² Installa NutriPlan come app</span>
  <button class="btn btn-primary btn-small" id="installBtn">Installa</button>
  <button class="btn btn-secondary btn-small" id="dismissBtn">âœ•</button>
</div>

<!-- DATALIST AUTOCOMPLETE -->
<datalist id="ingredientiDatalist"></datalist>


<!-- ============================================================
     SCRIPTS â€” ordine fondamentale
     ============================================================ -->

<!-- Firebase Compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- App scripts in ordine corretto -->
<script src="data.js"></script>
<script src="storage.js"></script>
<script src="app.js"></script>
<script src="piano.js"></script>
<script src="dispensa.js"></script>
<script src="ricette.js"></script>
<script src="spesa.js"></script>
<script src="storico.js"></script>
<script src="profilo.js"></script>
<script src="firebase-config.js"></script>

<!-- ============================================================
     PATCH E STUB INLINE
     (caricati DOPO tutti gli altri â€” possono sovrascrivere)
     ============================================================ -->
<script>

/* ---- 1. Stats stub (stats.js non esiste) ---- */
function renderStatistiche() {
  var el = document.getElementById('statsContent');
  if (!el) return;
  var totalDays  = Object.keys(appHistory || {}).filter(function(dk) {
    var hd = appHistory[dk]; if (!hd || !hd.usedItems) return false;
    return Object.keys(hd.usedItems).some(function(mk) { return Object.keys(hd.usedItems[mk]||{}).length > 0; });
  }).length;
  var allMeals = ['colazione','spuntino','pranzo','merenda','cena'];
  var totalUsed = 0;
  Object.keys(appHistory || {}).forEach(function(dk) {
    var ui = (appHistory[dk]||{}).usedItems || {};
    allMeals.forEach(function(mk) { totalUsed += Object.keys(ui[mk]||{}).length; });
  });
  var pantryCount = Object.keys(pantryItems || {}).filter(function(k) {
    return k && k !== 'undefined' && (pantryItems[k].quantity||0) > 0;
  }).length;
  el.innerHTML =
    '<div class="stats-grid">' +
      '<div class="stat-card"><div class="stat-card-icon">ğŸ“…</div><div class="stat-card-value">' + totalDays + '</div><div class="stat-card-label">Giorni tracciati</div></div>' +
      '<div class="stat-card"><div class="stat-card-icon">âœ…</div><div class="stat-card-value">' + totalUsed + '</div><div class="stat-card-label">Alimenti consumati</div></div>' +
      '<div class="stat-card"><div class="stat-card-icon">ğŸ§º</div><div class="stat-card-value">' + pantryCount + '</div><div class="stat-card-label">In dispensa ora</div></div>' +
      '<div class="stat-card"><div class="stat-card-icon">ğŸ“–</div><div class="stat-card-value">' + ((customRecipes||[]).length) + '</div><div class="stat-card-label">Ricette personali</div></div>' +
    '</div>';
}

/* ---- 2. checkOnlineStatus stub ---- */
function checkOnlineStatus() {
  var s = navigator.onLine ? 'local' : 'local';
  showCloudStatus(s);
}

/* ---- 3. Override showCloudStatus per allinearsi alle classi CSS ---- */
function showCloudStatus(status) {
  var el = document.getElementById('cloudStatus');
  if (!el) return;
  var map = {
    local:  { cls: 'local',  text: 'ğŸ’¾ Locale'         },
    saving: { cls: 'saving', text: 'â³ Salvataggio...' },
    synced: { cls: 'synced', text: 'â˜ï¸ Sincronizzato'  },
    error:  { cls: 'error',  text: 'âš ï¸ Errore sync'    }
  };
  var s = map[status] || map.local;
  el.className = 'cloud-status ' + s.cls;
  el.textContent = s.text;
}

/* ---- 4. Patch adjustQty â†’ aggiorna anche il frigo ---- */
(function() {
  var _orig = window.adjustQty;
  if (typeof _orig !== 'function') return;
  window.adjustQty = function(name, delta) {
    _orig(name, delta);
    /* Aggiorna il frigo se Ã¨ visibile */
    var fc = document.getElementById('fridgeContent');
    if (fc && typeof renderFridge === 'function') renderFridge();
  };
})();

/* ---- 5. Ricetta form: alias e CRUD ---- */
var _rfEditIdx = null;

function openRicettaForm(idx) {
  _rfEditIdx = (idx !== undefined) ? idx : null;
  var titleEl = document.getElementById('ricettaFormTitle');
  var nomeEl  = document.getElementById('rfNome');
  var pastoEl = document.getElementById('rfPasto');
  var prepEl  = document.getElementById('rfPrep');
  var ingList = document.getElementById('rfIngList');
  if (!nomeEl) return;
  if (_rfEditIdx !== null && customRecipes[_rfEditIdx]) {
    var r = customRecipes[_rfEditIdx];
    if (titleEl)  titleEl.textContent = 'âœï¸ Modifica ricetta';
    nomeEl.value  = r.name || '';
    pastoEl.value = Array.isArray(r.pasto) ? r.pasto[0] : (r.pasto || 'pranzo');
    prepEl.value  = r.preparazione || '';
    ingList.innerHTML = '';
    (r.ingredienti || []).forEach(function(ing) { addRfIngRow(ing); });
  } else {
    if (titleEl)  titleEl.textContent = 'â­ Nuova ricetta';
    nomeEl.value  = '';
    pastoEl.value = 'pranzo';
    prepEl.value  = '';
    ingList.innerHTML = '';
    addRfIngRow();
  }
  var m = document.getElementById('ricettaFormModal');
  if (m) m.classList.add('active');
}

function closeRicettaForm() {
  var m = document.getElementById('ricettaFormModal');
  if (m) m.classList.remove('active');
  _rfEditIdx = null;
}

function addRfIngRow(ing) {
  ing = ing || {};
  var list = document.getElementById('rfIngList');
  if (!list) return;
  var units = ['g','ml','pz','fette','cucchiai','cucchiaini','porzione','kg','l'];
  var unitOpts = units.map(function(u) {
    return '<option value="' + u + '"' + ((ing.unit||'g') === u ? ' selected' : '') + '>' + u + '</option>';
  }).join('');
  var row = document.createElement('div');
  row.className = 'rf-ing-row';
  row.innerHTML =
    '<input type="text" class="form-input rf-ing-name" value="' + (ing.name||'') + '" placeholder="Ingrediente..." list="ingredientiDatalist">' +
    '<input type="number" class="form-input rf-ing-qty" value="' + (ing.quantity||'') + '" placeholder="QtÃ " min="0" step="any">' +
    '<select class="form-input rf-ing-unit">' + unitOpts + '</select>' +
    '<button class="btn-icon-only" style="width:32px;height:32px;background:var(--bg-light);border:1.5px solid var(--border);color:var(--danger,#e05252)" onclick="this.closest(\'.rf-ing-row\').remove()">âœ•</button>';
  list.appendChild(row);
}

function saveCustomRicetta() {
  var nome = (document.getElementById('rfNome').value || '').trim();
  if (!nome) { alert('Inserisci il nome della ricetta.'); return; }
  var pasto = document.getElementById('rfPasto').value;
  var prep  = (document.getElementById('rfPrep').value || '').trim();
  var ings  = [];
  document.querySelectorAll('#rfIngList .rf-ing-row').forEach(function(row) {
    var n = (row.querySelector('.rf-ing-name').value || '').trim();
    var q = parseFloat(row.querySelector('.rf-ing-qty').value) || null;
    var u = row.querySelector('.rf-ing-unit').value || 'g';
    if (n) ings.push({ name: n, quantity: q, unit: u });
  });
  var ricetta = { name: nome, icon: 'ğŸ½', pasto: pasto, ingredienti: ings, preparazione: prep, isCustom: true };
  if (!Array.isArray(customRecipes)) customRecipes = [];
  if (_rfEditIdx !== null && customRecipes[_rfEditIdx]) {
    customRecipes[_rfEditIdx] = ricetta;
  } else {
    customRecipes.push(ricetta);
  }
  saveData();
  closeRicettaForm();
  if (typeof renderCustomRicette === 'function') renderCustomRicette();
}

function editCustomRicetta(idx) { openRicettaForm(idx); }

function deleteCustomRicetta(idx) {
  if (!confirm('Eliminare questa ricetta?')) return;
  customRecipes.splice(idx, 1);
  saveData();
  if (typeof renderCustomRicette === 'function') renderCustomRicette();
}

/* ---- 6. updateSavedFridges: aggiorna entrambi i contenitori ---- */
function updateSavedFridges() {
  ['savedFridgesContent','savedFridgesContent2'].forEach(function(elId) {
    var el = document.getElementById(elId);
    if (!el) return;
    var keys = Object.keys(savedFridges || {});
    if (!keys.length) {
      el.innerHTML = '<p style="color:var(--text-light);font-size:.84em">Nessuna configurazione salvata.</p>';
      return;
    }
    el.innerHTML = keys.map(function(k) {
      var f  = savedFridges[k];
      var n  = Object.keys(f.items || {}).length;
      var sk = k.replace(/'/g,"\\'");
      return '<div class="saved-fridge-item">' +
        '<div class="saved-fridge-name">ğŸ“ ' + k + '</div>' +
        '<div class="saved-fridge-date">ğŸ• ' + (f.date||'') + ' Â· ' + n + ' ingredienti</div>' +
        '<div class="saved-fridge-actions">' +
          '<button class="btn btn-secondary btn-small" onclick="loadFridge(\'' + sk + '\')">ğŸ“‚ Carica</button>' +
          '<button class="btn btn-warning btn-small" onclick="deleteFridge(\'' + sk + '\')">ğŸ—‘</button>' +
        '</div></div>';
    }).join('');
  });
}

/* ---- 7. initCalendar alias (usato da alcune versioni di piano.js) ---- */
function initCalendar() {
  if (typeof buildCalendarBar === 'function') buildCalendarBar();
}

/* ---- 8. renderWeeklyLimits alias (usato da alcune versioni) ---- */
function renderWeeklyLimits() {
  if (typeof updateLimits === 'function') updateLimits();
}

/* ---- 9. initDayIngGrid: mostra gli ingredienti del giorno ---- */
function initDayIngGrid() {
  var el = document.getElementById('dayIngredientsGrid');
  if (!el) return;
  var allItems = (typeof getAllPantryItems === 'function') ? getAllPantryItems() : [];
  var active = allItems.filter(function(i) { return (i.quantity||0) > 0; });
  if (!active.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ›’</div><h3>Nessun ingrediente</h3><p>Aggiungi quantitÃ  in dispensa o segna acquisti dalla spesa.</p></div>';
    return;
  }
  var html = '<div class="pantry-grid" style="margin-top:8px">';
  active.forEach(function(item) {
    html += '<div class="pantry-item active">' +
      '<div class="pantry-item-top">' +
        '<div class="pantry-item-name-row">' +
          '<span class="pantry-icon">' + item.icon + '</span>' +
          '<span class="pantry-name">' + item.name + '</span>' +
        '</div>' +
      '</div>' +
      '<div style="font-size:.82em;color:var(--primary);font-weight:800;margin-top:4px">' + item.quantity + ' ' + item.unit + '</div>' +
    '</div>';
  });
  html += '</div>';
  el.innerHTML = html;
}

/* ---- 10. Chiusura modale cliccando fuori ---- */
document.addEventListener('click', function(e) {
  var modalIds = ['recipeModal','saveFridgeModal','customIngModal','ricettaFormModal','spesaItemModal'];
  modalIds.forEach(function(id) {
    var m = document.getElementById(id);
    if (m && m.classList.contains('active') && e.target === m) {
      m.classList.remove('active');
    }
  });
});

</script>

</body>
</html>
