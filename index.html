<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NutriPlan</title>
    <link id="manifest-placeholder" rel="manifest">
    <link id="appleTouchIcon" rel="apple-touch-icon">
    <meta id="metaThemeColor" name="theme-color" content="#4a9b7f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NutriPlan">

    <!-- Firebase SDK â€” DEVE stare prima di tutto -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- ===================== LANDING ===================== -->
<div id="landingPage">
    <div id="landingLogo"></div>
    <h1 class="landing-title">NutriPlan</h1>
    <p class="landing-sub">Il tuo piano alimentare personale</p>
    <button class="btn btn-primary btn-large" onclick="enterApp()">â–¶ Inizia</button>
</div>

<!-- ===================== MAIN APP ===================== -->
<div id="mainApp">

    <!-- HEADER -->
    <header class="app-header">
        <div class="header-left">
            <canvas id="headerIcon" width="32" height="32"></canvas>
            <span class="header-title">NutriPlan</span>
        </div>
        <div class="header-center">
            <span id="cloudStatus" class="cloud-status local">ğŸ’¾ Locale</span>
        </div>
        <div class="header-right">
            <img id="authAvatar" class="auth-avatar" style="display:none" alt="avatar">
            <span id="authInfo" class="auth-info"></span>
            <button id="authBtn" class="btn btn-secondary btn-small" onclick="signInWithGoogle()">
                Accedi con Google
            </button>
            <button id="darkToggle" class="btn-icon-only" onclick="toggleDarkMode()">ğŸŒ™</button>
        </div>
    </header>

    <!-- NAVBAR -->
    <nav class="bottom-nav">
        <button class="nav-tab active" onclick="showPage('piano', this)">ğŸ <span>Piano</span></button>
        <button class="nav-tab" onclick="showPage('dispensa', this)">ğŸ§º<span>Dispensa</span></button>
        <button class="nav-tab" onclick="showPage('ricette', this)">ğŸ“–<span>Ricette</span></button>
        <button class="nav-tab" onclick="showPage('storico', this)">ğŸ“…<span>Storico</span></button>
        <button class="nav-tab" onclick="showPage('spesa', this)">ğŸ›’<span>Spesa</span></button>
        <button class="nav-tab" onclick="showPage('statistiche', this)">ğŸ“Š<span>Stats</span></button>
        <button class="nav-tab" onclick="showPage('profilo', this)">ğŸ‘¤<span>Profilo</span></button>
    </nav>

    <!-- PAGES -->
    <main class="app-main">

        <!-- ===== PIANO ===== -->
        <div id="pianoPage" class="page active">
            <!-- Calendario -->
            <div class="calendar-bar-wrap">
                <div id="calendarBar" class="calendar-bar"></div>
            </div>
            <div id="currentDateLabel" class="current-date-label"></div>

            <!-- Tabs -->
            <div class="page-tabs">
                <button class="page-tab active" onclick="showPianoTab('pasto', this)">ğŸ½ï¸ Pasto</button>
                <button class="page-tab" onclick="showPianoTab('frigo', this)">â„ï¸ Frigo</button>
                <button class="page-tab" onclick="showPianoTab('ingredienti', this)">ğŸ¥¦ Ingredienti</button>
                <button class="page-tab" onclick="showPianoTab('limiti', this)">ğŸ“Š Limiti</button>
            </div>

            <!-- Tab Pasto -->
            <div id="pianoTabPasto" class="page-tab-content active">
                <div class="meal-select-row">
                    <select id="mealSelect" class="form-input meal-select" onchange="renderMealPlan()">
                        <option value="colazione">â˜• Colazione</option>
                        <option value="spuntino">ğŸ Spuntino</option>
                        <option value="pranzo" selected>ğŸ½ï¸ Pranzo</option>
                        <option value="merenda">ğŸ¥ª Merenda</option>
                        <option value="cena">ğŸŒ™ Cena</option>
                    </select>
                </div>
                <div id="mealPlanContainer"></div>
            </div>

            <!-- Tab Frigo -->
            <div id="pianoTabFrigo" class="page-tab-content">
                <div class="section-header">
                    <h3>â„ï¸ Suggerimenti dal frigo</h3>
                    <select id="fridgeMealFilter" class="form-input form-input-small" onchange="updateFridgeSuggestions()">
                        <option value="tutti">Tutti i pasti</option>
                        <option value="colazione">â˜• Colazione</option>
                        <option value="spuntino">ğŸ Spuntino</option>
                        <option value="pranzo">ğŸ½ï¸ Pranzo</option>
                        <option value="merenda">ğŸ¥ª Merenda</option>
                        <option value="cena">ğŸŒ™ Cena</option>
                    </select>
                </div>
                <div id="fridgeSuggestionsList"></div>
            </div>

            <!-- Tab Ingredienti -->
            <div id="pianoTabIngredienti" class="page-tab-content">
                <div class="section-header">
                    <h3>ğŸ¥¦ Cerca per ingredienti</h3>
                    <button class="btn btn-secondary btn-small" onclick="clearDayIngredients()">âœ• Pulisci</button>
                </div>
                <div id="dayIngGrid" class="day-ing-grid"></div>
                <button class="btn btn-primary" onclick="searchByIngredients()"
                    style="width:100%;margin-top:12px;">ğŸ” Cerca ricette</button>
                <div id="ingredientSuggestionsList" style="margin-top:16px;"></div>
            </div>

            <!-- Tab Limiti -->
            <div id="pianoTabLimiti" class="page-tab-content">
                <div class="section-header">
                    <h3>ğŸ“Š Limiti settimanali</h3>
                    <button class="btn btn-warning btn-small" onclick="resetWeek()">ğŸ”„ Reset</button>
                </div>
                <div id="limitsGrid" class="limits-grid"></div>
            </div>
        </div>

        <!-- ===== DISPENSA ===== -->
        <div id="dispensaPage" class="page">
            <div class="page-tabs">
                <button class="page-tab active" onclick="showDispensaTab('dispensa', this)">ğŸ§º Dispensa</button>
                <button class="page-tab" onclick="showDispensaTab('frigo', this)">â„ï¸ Frigo</button>
            </div>

            <!-- Tab Dispensa -->
            <div id="dispensaTabDispensa" class="page-tab-content active">
                <!-- BARRA RICERCA + PULSANTE + -->
                <div class="search-bar-row">
                    <div class="search-input-wrap">
                        <input type="text" id="dispensaSearch"
                            placeholder="ğŸ” Cerca ingrediente..."
                            oninput="filterDispensa(this.value)"
                            class="form-input search-input">
                        <button id="dispensaClearBtn" class="search-clear-btn"
                            onclick="clearDispensaSearch()" style="display:none;">âœ•</button>
                    </div>
                    <!-- PULSANTE + PER INGREDIENTE CUSTOM -->
                    <button class="btn btn-primary btn-add-ing"
                        onclick="openCustomIngModal()"
                        title="Aggiungi ingrediente personalizzato">ï¼‹</button>
                </div>
                <div id="pantryContent"></div>
            </div>

            <!-- Tab Frigo -->
            <div id="dispensaTabFrigo" class="page-tab-content">
                <div class="section-header">
                    <h3>â„ï¸ Il tuo frigo</h3>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-secondary btn-small" onclick="openSaveFridgeModal()">ğŸ’¾ Salva</button>
                        <button class="btn btn-warning btn-small" onclick="clearFridge()">ğŸ—‘ï¸ Svuota</button>
                    </div>
                </div>
                <div id="fridgeContent"></div>
                <div id="savedFridgesCard" style="display:none;margin-top:20px;">
                    <h3 style="margin-bottom:12px;">ğŸ“‚ Frigo salvati</h3>
                    <div id="savedFridgeList"></div>
                </div>
            </div>
        </div>

        <!-- ===== RICETTE ===== -->
        <div id="ricettePage" class="page">
            <div class="page-tabs">
                <button class="page-tab active" onclick="showRicetteTab('catalogo', this)">ğŸ“š Catalogo</button>
                <button class="page-tab" onclick="showRicetteTab('custom', this)">â­ Le mie</button>
            </div>

            <!-- Tab Catalogo -->
            <div id="ricetteTabCatalogo" class="page-tab-content active">
                <div class="search-bar-row">
                    <div class="search-input-wrap">
                        <input type="text" id="ricetteSearch"
                            placeholder="ğŸ” Cerca ricetta o ingrediente..."
                            oninput="filterRicette(this.value)"
                            class="form-input search-input">
                        <button id="ricetteClearBtn" class="search-clear-btn"
                            onclick="clearRicetteSearch()" style="display:none;">âœ•</button>
                    </div>
                </div>
                <div class="ricette-filter-row">
                    <button class="ricette-filter-btn active" onclick="setRicetteMealFilter('tutti', this)">Tutti</button>
                    <button class="ricette-filter-btn" onclick="setRicetteMealFilter('colazione', this)">â˜•</button>
                    <button class="ricette-filter-btn" onclick="setRicetteMealFilter('spuntino', this)">ğŸ</button>
                    <button class="ricette-filter-btn" onclick="setRicetteMealFilter('pranzo', this)">ğŸ½ï¸</button>
                    <button class="ricette-filter-btn" onclick="setRicetteMealFilter('merenda', this)">ğŸ¥ª</button>
                    <button class="ricette-filter-btn" onclick="setRicetteMealFilter('cena', this)">ğŸŒ™</button>
                </div>
                <div id="ricetteCatalogoContent"></div>
            </div>

            <!-- Tab Le mie -->
            <div id="ricetteTabCustom" class="page-tab-content">
                <div class="section-header">
                    <h3>â­ Le mie ricette</h3>
                    <button class="btn btn-primary btn-small" onclick="openRicettaForm()">â• Nuova Ricetta</button>
                </div>
                <div id="ricetteCustomContent"></div>
            </div>
        </div>

        <!-- ===== STORICO ===== -->
        <div id="storicoPage" class="page">
            <div id="storicoContent"></div>
        </div>

        <!-- ===== SPESA ===== -->
        <div id="spesaPage" class="page">
            <div id="spesaContent"></div>
        </div>

        <!-- ===== STATISTICHE ===== -->
        <div id="statistichePage" class="page">
            <div id="statisticheContent"></div>
        </div>

        <!-- ===== PROFILO ===== -->
        <div id="profiloPage" class="page">
            <div id="profiloContent"></div>
        </div>

    </main>
</div>

<!-- ===================== MODALS ===================== -->

<!-- Modal: Dettaglio Ricetta -->
<div id="recipeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="recipeModalTitle"></h3>
            <button class="modal-close" onclick="closeRecipeModal()">âœ•</button>
        </div>
        <div id="recipeModalBody" class="modal-body"></div>
        <div class="modal-footer">
            <button id="recipeModalSelectBtn" class="btn btn-primary"
                onclick="selectRecipeFromModal()" style="display:none;">âœ“ Usa questa ricetta</button>
        </div>
    </div>
</div>

<!-- Modal: Salva Frigo -->
<div id="saveFridgeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ’¾ Salva frigo</h3>
            <button class="modal-close" onclick="closeSaveFridgeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Nome configurazione</label>
                <input type="text" id="fridgeName" placeholder="es. Frigo lunedÃ¬..."
                    class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSaveFridgeModal()">Annulla</button>
            <button class="btn btn-primary" onclick="saveFridge()">ğŸ’¾ Salva</button>
        </div>
    </div>
</div>

<!-- Modal: Ingrediente Custom â€” CON CATEGORIA -->
<div id="customIngModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>â• Nuovo Ingrediente</h3>
            <button class="modal-close" onclick="closeCustomIngModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Nome *</label>
                <input type="text" id="ciName" placeholder="es. Tofu, Tempeh, Edamame..."
                    class="form-input">
            </div>
            <div class="form-group">
                <label>Emoji / Icona</label>
                <input type="text" id="ciIcon" placeholder="es. ğŸ¥—" class="form-input"
                    maxlength="4">
            </div>
            <!-- CAMPO CATEGORIA -->
            <div class="form-group">
                <label>Categoria</label>
                <select id="ciCategoria" class="form-input">
                    <option value="">â­ Personalizzati (nessuna categoria)</option>
                    <!-- popolato dinamicamente da dispensa.js -->
                </select>
            </div>
            <div class="form-group">
                <label>UnitÃ  di misura</label>
                <select id="ciUnit" class="form-input">
                    <option value="g">g (grammi)</option>
                    <option value="ml">ml (millilitri)</option>
                    <option value="pz">pz (pezzi)</option>
                    <option value="cucchiai">cucchiai</option>
                    <option value="cucchiaini">cucchiaini</option>
                    <option value="tazze">tazze</option>
                    <option value="fette">fette</option>
                </select>
            </div>
            <div class="form-group">
                <label>Step quantitÃ  (es. 10 = incrementi da 10)</label>
                <input type="number" id="ciStep" value="10" min="1" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCustomIngModal()">Annulla</button>
            <button class="btn btn-primary" onclick="saveCustomIngredient()">âœ“ Aggiungi</button>
        </div>
    </div>
</div>

<!-- Modal: Form Ricetta Custom -->
<div id="ricettaFormModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="ricettaFormTitle">ğŸ³ Nuova Ricetta</h3>
            <button class="modal-close" onclick="closeRicettaForm()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Nome ricetta *</label>
                <input type="text" id="rfNome" placeholder="es. Pasta al pomodoro..."
                    class="form-input">
            </div>
            <div class="form-group">
                <label>Pasto</label>
                <select id="rfPasto" class="form-input">
                    <option value="colazione">â˜• Colazione</option>
                    <option value="spuntino">ğŸ Spuntino</option>
                    <option value="pranzo" selected>ğŸ½ï¸ Pranzo</option>
                    <option value="merenda">ğŸ¥ª Merenda</option>
                    <option value="cena">ğŸŒ™ Cena</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ingredienti</label>
                <div id="rfIngList"></div>
                <datalist id="ingredientiSuggeriti"></datalist>
                <button class="btn btn-secondary btn-small" onclick="addRfIng()"
                    style="margin-top:8px;">â• Aggiungi ingrediente</button>
            </div>
            <div class="form-group">
                <label>Istruzioni / Preparazione</label>
                <textarea id="rfIstruzioni" class="form-input form-textarea"
                    rows="5" placeholder="Descrivi i passaggi di preparazione..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeRicettaForm()">Annulla</button>
            <button class="btn btn-primary" onclick="saveRicettaCustom()">âœ“ Salva Ricetta</button>
        </div>
    </div>
</div>

<!-- Modal: Spesa Item -->
<div id="spesaItemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="spesaItemModalTitle">Articolo</h3>
            <button class="modal-close" onclick="closeSpesaItemModal()">âœ•</button>
        </div>
        <div id="spesaItemModalBody" class="modal-body"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSpesaItemModal()">Chiudi</button>
        </div>
    </div>
</div>

<!-- ===================== BANNERS ===================== -->

<div id="iosBanner" class="ios-banner">
    <div class="ios-banner-content">
        <span>ğŸ“² Installa NutriPlan: tocca <strong>Condividi</strong> poi <strong>"Aggiungi a Home"</strong></span>
        <button onclick="closeIosBanner()">âœ•</button>
    </div>
</div>

<div id="installBanner" class="install-banner">
    <div class="install-banner-content">
        <span>ğŸ“² Installa NutriPlan come app!</span>
        <button id="installBtn" class="btn btn-primary btn-small">Installa</button>
        <button id="dismissBtn" class="btn btn-secondary btn-small">âœ•</button>
    </div>
</div>

<div id="offlineIndicator" class="offline-indicator">ğŸ“µ Offline</div>

<!-- ===================== SCRIPTS ===================== -->
<!-- Ordine OBBLIGATORIO: firebase-config â†’ data â†’ storage â†’ tutto il resto -->
<script src="firebase-config.js"></script>
<script src="data.js"></script>
<script src="storage.js"></script>
<script src="app.js"></script>
<script src="piano.js"></script>
<script src="dispensa.js"></script>
<script src="ricette.js"></script>
<script src="ricette_custom.js"></script>
<script src="storico.js"></script>
<script src="spesa.js"></script>
<script src="statistiche.js"></script>
<script src="pdf.js"></script>
<script src="profilo.js"></script>

</body>
</html>
