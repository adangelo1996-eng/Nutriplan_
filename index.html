<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta id="metaThemeColor" name="theme-color" content="#4a9b7f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>NutriPlan</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
    /* ‚îÄ‚îÄ SIDEBAR DESKTOP ‚îÄ‚îÄ */
    .sidebar-nav {
      display: none; position: fixed; top: 0; left: 0; bottom: 0;
      width: var(--sidebar-w, 210px); background: var(--bg-card);
      border-right: 1px solid var(--border); flex-direction: column;
      padding-top: var(--header-h, 56px); z-index: 100;
      overflow-y: auto; box-shadow: 2px 0 12px rgba(0,0,0,.06);
    }
    .sidebar-nav .nav-tab {
      flex: none; flex-direction: row; justify-content: flex-start;
      gap: 12px; padding: 13px 20px; border-radius: 0;
      font-size: .88em; width: 100%; color: var(--text-mid);
    }
    .sidebar-nav .nav-tab .nav-icon  { font-size: 1.2em; }
    .sidebar-nav .nav-tab .nav-label { font-size: 1em; max-width: none; }
    .sidebar-nav .nav-tab.active {
      background: var(--primary-light); color: var(--primary);
      border-left: 3px solid var(--primary);
    }
    .sidebar-nav .nav-tab.active::after { display: none; }
    @media (min-width: 768px) {
      .sidebar-nav { display: flex; }
      .bottom-nav  { display: none !important; }
      .app-main    { margin-left: var(--sidebar-w, 210px) !important; margin-bottom: 0 !important; }
    }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.45); z-index: 500;
      align-items: center; justify-content: center; padding: 16px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--bg-card); border-radius: var(--radius-lg);
      width: 100%; max-width: 480px; max-height: 90dvh;
      overflow-y: auto; box-shadow: var(--shadow-lg);
      animation: fadeIn .18s ease;
    }
    .modal-content-large { max-width: 600px; }
    .modal-content-small { max-width: 320px; }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 18px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--bg-card); z-index: 1;
    }
    .modal-header h3 { font-size: 1em; font-weight: 800; margin: 0; }
    .modal-close {
      background: none; border: none; font-size: 1.1em; cursor: pointer;
      color: var(--text-light); padding: 4px; line-height: 1;
      border-radius: var(--radius-xs); transition: background .2s;
    }
    .modal-close:hover { background: var(--border); }
    .modal-body   { padding: 18px; }
    .modal-footer {
      display: flex; gap: 8px; justify-content: flex-end;
      padding: 14px 18px; border-top: 1px solid var(--border);
    }

    /* ‚îÄ‚îÄ FRIGO CARD ‚îÄ‚îÄ */
    .fridge-category-section { margin-bottom: 22px; }
    .category-title { font-size: .78em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .cat-count-badge {
      display: inline-flex; align-items: center; justify-content: center;
      background: var(--primary); color: #fff; font-size: .62em; font-weight: 800;
      width: 18px; height: 18px; border-radius: 50%;
    }
    .fridge-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(118px, 1fr));
      gap: 10px;
    }
    .fridge-item {
      background: var(--bg-card); border-radius: var(--radius);
      padding: 14px 10px 12px; text-align: center;
      box-shadow: var(--shadow); border: 1.5px solid var(--border);
      display: flex; flex-direction: column; align-items: center; gap: 5px;
      transition: border-color .2s, box-shadow .2s; position: relative;
    }
    .fridge-item:hover { border-color: var(--primary); box-shadow: var(--shadow-lg); }
    .fridge-item-icon  { font-size: 2em; line-height: 1; margin-bottom: 2px; }
    .fridge-item-name  { font-size: .76em; font-weight: 700; line-height: 1.3; word-break: break-word; }
    .fridge-item-qty   {
      font-size: .85em; color: var(--primary); font-weight: 800;
      background: var(--primary-light); border-radius: var(--radius-xs);
      padding: 2px 8px; margin: 2px 0; cursor: pointer; transition: background .2s;
    }
    .fridge-item-qty:hover { background: color-mix(in srgb, var(--primary) 20%, transparent); }
    .fridge-qty-btns { display: flex; gap: 6px; margin-top: 4px; }
    .qty-btn {
      width: 30px; height: 30px; border: 1.5px solid var(--border);
      border-radius: var(--radius-xs); background: var(--bg-light);
      cursor: pointer; font-size: 1em; font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      color: var(--text); transition: all .15s; flex-shrink: 0;
    }
    .qty-btn:hover  { background: var(--primary); color: #fff; border-color: var(--primary); }
    .qty-btn:active { transform: scale(.88); }
    .fridge-delete-btn {
      background: none; border: none; cursor: pointer; font-size: .7em;
      color: var(--text-light); position: absolute; top: 5px; right: 5px;
      padding: 2px 4px; border-radius: var(--radius-xs); transition: color .2s;
    }
    .fridge-delete-btn:hover { color: var(--danger, #e05252); }

    /* ‚îÄ‚îÄ STORICO ‚îÄ‚îÄ */
    .storico-list { display: flex; flex-direction: column; gap: 8px; }
    .storico-day  { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
    .storico-day-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; cursor: pointer; gap: 8px; }
    .storico-day-header:hover { background: var(--bg-light); }
    .storico-day-label  { font-weight: 800; font-size: .9em; }
    .storico-day-count  { font-size: .78em; color: var(--text-light); font-weight: 600; }
    .storico-day-toggle { color: var(--text-light); font-size: .9em; }
    .storico-day-detail { padding: 0 14px 12px; }
    .storico-meal-block { margin-bottom: 10px; }
    .storico-meal-title { font-size: .76em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 6px; }
    .storico-item { display: flex; align-items: center; justify-content: space-between; font-size: .84em; padding: 4px 0; border-bottom: 1px solid var(--border); }
    .storico-item:last-child { border-bottom: none; }
    .storico-item-qty { color: var(--text-light); font-size: .9em; }

    /* ‚îÄ‚îÄ SPESA ‚îÄ‚îÄ */
    .spesa-header-row   { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
    .spesa-title        { font-size: 1.05em; font-weight: 800; }
    .spesa-subtitle     { font-size: .76em; color: var(--text-light); margin-top: 2px; }
    .spesa-section-title{ font-size: .74em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: .06em; margin: 14px 0 6px; }
    .spesa-progress-row { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
    .spesa-progress-bar { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .spesa-progress-fill{ height: 100%; background: linear-gradient(90deg, var(--primary), var(--success, #3aaa6e)); border-radius: 3px; transition: width .5s; }
    .spesa-progress-label{ font-size: .78em; font-weight: 700; color: var(--text-mid); white-space: nowrap; }
    .spesa-list         { display: flex; flex-direction: column; gap: 5px; }
    .spesa-item         { display: flex; align-items: center; gap: 10px; background: var(--bg-card); border-radius: var(--radius-sm); padding: 11px 12px; border: 1.5px solid var(--border); cursor: pointer; transition: all .2s; }
    .spesa-item:hover   { background: var(--bg-light); }
    .spesa-item.done    { opacity: .6; }
    .spesa-item-check   { font-size: 1.1em; flex-shrink: 0; }
    .spesa-item-info    { flex: 1; min-width: 0; }
    .spesa-item-name    { font-size: .88em; font-weight: 700; }
    .spesa-item.done .spesa-item-name { text-decoration: line-through; color: var(--text-light); }
    .spesa-item-qty     { font-size: .76em; color: var(--text-light); margin-top: 2px; }
    .spesa-item-actions { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
    .spesa-badge-auto   { font-size: .65em; font-weight: 800; background: var(--primary-light); color: var(--primary); padding: 2px 6px; border-radius: 10px; }
    .spesa-badge-manual { font-size: .65em; font-weight: 800; background: var(--bg-light); color: var(--text-light); padding: 2px 6px; border-radius: 10px; }
    .spesa-delete-btn   { background: none; border: none; cursor: pointer; font-size: .85em; color: var(--text-light); padding: 3px; border-radius: var(--radius-xs); }
    .spesa-delete-btn:hover { color: var(--danger, #e05252); background: var(--bg-light); }
    .spesa-add-row      { display: flex; gap: 8px; align-items: center; }

    /* ‚îÄ‚îÄ PROFILO ‚îÄ‚îÄ */
    .profilo-section    { background: var(--bg-card); border-radius: var(--radius-lg); padding: 18px; margin-bottom: 14px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .profilo-title      { font-size: .95em; font-weight: 800; margin: 0 0 14px; }
    .profilo-user-card  { display: flex; align-items: center; gap: 14px; }
    .profilo-avatar     { width: 56px; height: 56px; border-radius: 50%; border: 3px solid var(--primary); }
    .profilo-avatar-placeholder { width: 56px; height: 56px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 1.6em; flex-shrink: 0; }
    .profilo-user-name  { font-weight: 800; font-size: 1em; }
    .profilo-user-email { font-size: .78em; color: var(--text-light); margin-top: 2px; }
    .profilo-sync-info  { font-size: .74em; color: var(--primary); margin-top: 4px; font-weight: 700; }
    .profilo-noauth-card{ text-align: center; padding: 20px 10px; }
    .profilo-meal-section { background: var(--bg-light); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 8px; border: 1px solid var(--border); }
    .profilo-meal-header  { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .profilo-meal-title   { font-size: .82em; font-weight: 800; }
    .profilo-empty-meal   { font-size: .8em; color: var(--text-light); font-style: italic; }
    .profilo-item-row     { display: flex; gap: 6px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }
    .profilo-item-name    { flex: 2; min-width: 100px; }
    .edit-item-row        { display: flex; gap: 6px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }

    /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
    .stats-grid   { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap: 10px; margin-bottom: 20px; }
    .stat-card    { background: var(--bg-card); border-radius: var(--radius); padding: 16px 12px; text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .stat-card-icon  { font-size: 1.8em; margin-bottom: 6px; }
    .stat-card-value { font-size: 1.4em; font-weight: 800; color: var(--primary); }
    .stat-card-label { font-size: .72em; color: var(--text-light); margin-top: 3px; font-weight: 700; }

    /* ‚îÄ‚îÄ LIMITI ‚îÄ‚îÄ */
    .limit-card       { background: var(--bg-card); border-radius: var(--radius); padding: 14px 12px; text-align: center; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
    .limit-card.warning  { border-color: var(--warning, #f0a500); }
    .limit-card.exceeded { border-color: var(--danger,  #e05252); }
    .limit-card-icon  { font-size: 1.6em; margin-bottom: 5px; }
    .limit-card-name  { font-size: .72em; font-weight: 800; color: var(--text-light); margin-bottom: 8px; text-transform: uppercase; letter-spacing: .04em; }
    .limit-progress-bar  { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
    .limit-progress-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width .4s; }
    .limit-progress-fill.warning  { background: var(--warning, #f0a500); }
    .limit-progress-fill.exceeded { background: var(--danger,  #e05252); }
    .limit-text         { font-size: .76em; font-weight: 800; color: var(--text-mid); }
    .limit-text.warning  { color: var(--warning, #f0a500); }
    .limit-text.exceeded { color: var(--danger,  #e05252); }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty-state      { text-align: center; padding: 48px 20px; color: var(--text-light); }
    .empty-state-icon { font-size: 2.6em; margin-bottom: 12px; }
    .empty-state h3   { font-size: 1em; font-weight: 800; color: var(--text-mid); margin-bottom: 6px; }
    .empty-state p    { font-size: .84em; line-height: 1.6; }

    /* ‚îÄ‚îÄ BANNERS ‚îÄ‚îÄ */
    .ios-banner {
      display: none; position: fixed; bottom: 80px; left: 16px; right: 16px;
      background: var(--bg-card); border-radius: var(--radius); padding: 14px 16px;
      box-shadow: var(--shadow-lg); z-index: 400; border: 1px solid var(--border);
    }
    .ios-banner.show { display: flex; align-items: center; gap: 10px; }
    .install-banner {
      display: none; position: fixed; top: calc(var(--header-h,56px) + 8px);
      left: 50%; transform: translateX(-50%);
      background: var(--bg-card); border-radius: var(--radius); padding: 10px 14px;
      box-shadow: var(--shadow-lg); z-index: 300; border: 1px solid var(--border);
      gap: 10px; align-items: center; white-space: nowrap; font-size: .84em; font-weight: 700;
    }
    .install-banner.show { display: flex; }

    /* ‚îÄ‚îÄ RICETTA FORM ‚îÄ‚îÄ */
    .rf-ing-row  { display: flex; gap: 5px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }
    .rf-ing-name { flex: 2; min-width: 100px; }
    .rf-ing-qty  { width: 68px !important; flex: none; }
    .rf-ing-unit { width: 78px !important; flex: none; }
  </style>
</head>
<body>

<!-- ============================================================
     LANDING
     ============================================================ -->
<div id="landingPage">
  <div id="landingLogo"></div>
  <div class="landing-title">NutriPlan</div>
  <div class="landing-sub">Il tuo piano alimentare personale</div>
  <button class="btn btn-primary btn-large" onclick="enterApp()">‚ñ∂ Inizia</button>
</div>


<!-- ============================================================
     APP
     ============================================================ -->
<div id="mainApp">

  <!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
  <header class="app-header">
    <div class="app-inner">
      <div class="header-left">
        <canvas id="headerIcon" width="32" height="32"></canvas>
        <span class="header-title">NutriPlan</span>
      </div>
      <div class="header-right">
        <span id="cloudStatus" class="cloud-status local">üíæ Locale</span>
        <!-- Accedi ‚Äî visibile se NON loggato -->
        <button id="loginBtn"
                class="btn-icon-only"
                onclick="signInWithGoogle()"
                title="Accedi con Google"
                style="display:flex">üîë</button>
        <!-- Avatar ‚Äî visibile se loggato -->
        <div id="authUserPill" class="auth-user-pill" style="display:none">
          <img id="authAvatar" class="auth-avatar" src="" alt="">
          <span id="authName" class="auth-info"></span>
        </div>
        <!-- Disconnetti ‚Äî visibile se loggato -->
        <button id="logoutBtn"
                class="btn-icon-only"
                onclick="signOut()"
                title="Disconnetti"
                style="display:none">üö™</button>
        <!-- Dark mode -->
        <button id="darkToggle"
                class="btn-icon-only"
                onclick="toggleDarkMode()"
                title="Tema">üåô</button>
      </div>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ SIDEBAR (desktop ‚â•768px) ‚îÄ‚îÄ -->
  <aside class="sidebar-nav">
    <button class="nav-tab active" onclick="showPage('piano',this)">
      <span class="nav-icon">üè†</span><span class="nav-label">Piano</span>
    </button>
    <button class="nav-tab" onclick="showPage('dispensa',this)">
      <span class="nav-icon">‚ùÑÔ∏è</span><span class="nav-label">Frigo</span>
    </button>
    <button class="nav-tab" onclick="showPage('ricette',this)">
      <span class="nav-icon">üìñ</span><span class="nav-label">Ricette</span>
    </button>
    <button class="nav-tab" onclick="showPage('storico',this)">
      <span class="nav-icon">üìÖ</span><span class="nav-label">Storico</span>
    </button>
    <button class="nav-tab" onclick="showPage('spesa',this)">
      <span class="nav-icon">üõí</span><span class="nav-label">Spesa</span>
    </button>
    <button class="nav-tab" onclick="showPage('statistiche',this)">
      <span class="nav-icon">üìä</span><span class="nav-label">Stats</span>
    </button>
    <button class="nav-tab" onclick="showPage('profilo',this)">
      <span class="nav-icon">üë§</span><span class="nav-label">Profilo</span>
    </button>
  </aside>

  <!-- ‚îÄ‚îÄ CONTENUTO ‚îÄ‚îÄ -->
  <main class="app-main">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PIANO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="pianoPage" class="page active">

      <!-- Calendario -->
      <div class="calendar-wrap">
        <div class="calendar-bar-wrap">
          <div class="calendar-bar" id="calendarBar"></div>
        </div>
        <div class="current-date-label" id="currentDateLabel"></div>
      </div>

      <!-- Tabs -->
      <div class="page-tabs">
        <button class="page-tab active" onclick="showPianoTab('pasto',this)">üçΩ Pasto</button>
        <button class="page-tab"        onclick="showPianoTab('frigo',this)">‚ùÑÔ∏è Frigo</button>
        <button class="page-tab"        onclick="showPianoTab('giorno',this)">üåø Ingredienti</button>
        <button class="page-tab"        onclick="showPianoTab('limiti',this)">üìä Limiti</button>
      </div>

      <!-- TAB: PASTO -->
      <div id="pianoTabPasto" class="page-tab-content active">
        <div id="mealProgressWrap"></div>
        <div id="mealSelector" class="meal-selector"></div>
        <div id="mealItemsList"></div>
      </div>

      <!-- TAB: FRIGO (suggerimenti ricette) -->
      <div id="pianoTabFrigo" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">‚ùÑÔ∏è Ricette con quel che hai</span>
          <button class="btn btn-secondary btn-small" onclick="openSaveFridgeModal()">üíæ Salva</button>
        </div>
        <div id="fridgeSuggestions"></div>
        <div class="section-header" style="margin-top:20px">
          <span class="section-title">üìÅ Frigo salvati</span>
        </div>
        <div id="savedFridgesContent"></div>
      </div>

      <!-- TAB: INGREDIENTI DEL GIORNO -->
      <div id="pianoTabGiorno" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">üåø Ingredienti del giorno</span>
        </div>
        <div id="dayIngredientsGrid"></div>
      </div>

      <!-- TAB: LIMITI SETTIMANALI -->
      <div id="pianoTabLimiti" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">üìä Limiti settimanali</span>
          <button class="btn btn-secondary btn-small" onclick="resetWeek()">üîÑ Reset</button>
        </div>
        <div id="limitsGrid" class="limits-grid"></div>
      </div>

    </div><!-- /pianoPage -->


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FRIGO (ex Dispensa) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="dispensaPage" class="page">

      <!-- Barra ricerca + pulsanti azione -->
      <div class="search-bar-row" style="margin-bottom:14px">
        <div class="search-input-wrap" style="flex:1">
          <input type="text"
                 id="pantrySearch"
                 class="form-input search-input"
                 placeholder="üîç Cerca nel frigo..."
                 oninput="filterPantry(this.value)"
                 list="ingredientiDatalist">
          <button class="search-clear-btn" onclick="clearPantrySearch()">‚úï</button>
        </div>
        <button class="btn-add-ing"
                onclick="openCustomIngModal()"
                title="Aggiungi ingrediente">Ôºã</button>
        <button class="btn btn-secondary btn-small"
                onclick="openSaveFridgeModal()"
                style="flex-shrink:0"
                title="Salva configurazione">üíæ</button>
      </div>

      <!-- Griglia frigo -->
      <div id="pantryContent"></div>

      <!-- Configurazioni salvate -->
      <div class="section-header" style="margin-top:24px">
        <span class="section-title">üìÅ Configurazioni salvate</span>
      </div>
      <div id="savedFridgesContent2"></div>

    </div><!-- /dispensaPage -->


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RICETTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="ricettePage" class="page">

      <div class="page-tabs">
        <button class="page-tab active" onclick="showRicetteTab('catalogo',this)">üìñ Catalogo</button>
        <button class="page-tab"        onclick="showRicetteTab('mie',this)">‚≠ê Le mie</button>
      </div>

      <div id="ricetteTabCatalogo" class="page-tab-content active">
        <input type="text"
               id="ricetteSearch"
               class="form-input"
               placeholder="üîç Cerca ricetta o ingrediente..."
               style="margin-bottom:12px"
               oninput="filterRicette(this.value)"
               list="ingredientiDatalist">
        <div id="ricetteFilterRow" class="ricette-filter-row"></div>
        <div id="ricetteGrid" class="ricette-grid"></div>
      </div>

      <div id="ricetteTabMie" class="page-tab-content">
        <div class="section-header">
          <span class="section-title">‚≠ê Le mie ricette</span>
          <button class="btn btn-primary btn-small" onclick="openRicettaForm()">Ôºã Nuova</button>
        </div>
        <div id="customRicetteList"></div>
      </div>

    </div><!-- /ricettePage -->


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STORICO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="storicoPage" class="page">
      <div class="section-header">
        <span class="section-title">üìÖ Storico pasti</span>
      </div>
      <div id="storicoContent"></div>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPESA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="spesaPage" class="page">
      <div id="spesaContent"></div>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATISTICHE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="statistichePage" class="page">
      <div class="section-header">
        <span class="section-title">üìä Statistiche</span>
      </div>
      <div id="statsContent"></div>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="profiloPage" class="page">
      <!-- popolato da renderProfilo() in profilo.js -->
    </div>

  </main>

  <!-- ‚îÄ‚îÄ BOTTOM NAV (mobile) ‚îÄ‚îÄ -->
  <nav class="bottom-nav">
    <div class="app-inner">
      <button class="nav-tab active" onclick="showPage('piano',this)">
        <span class="nav-icon">üè†</span><span class="nav-label">Piano</span>
      </button>
      <button class="nav-tab" onclick="showPage('dispensa',this)">
        <span class="nav-icon">‚ùÑÔ∏è</span><span class="nav-label">Frigo</span>
      </button>
      <button class="nav-tab" onclick="showPage('ricette',this)">
        <span class="nav-icon">üìñ</span><span class="nav-label">Ricette</span>
      </button>
      <button class="nav-tab" onclick="showPage('storico',this)">
        <span class="nav-icon">üìÖ</span><span class="nav-label">Storico</span>
      </button>
      <button class="nav-tab" onclick="showPage('spesa',this)">
        <span class="nav-icon">üõí</span><span class="nav-label">Spesa</span>
      </button>
      <button class="nav-tab" onclick="showPage('statistiche',this)">
        <span class="nav-icon">üìä</span><span class="nav-label">Stats</span>
      </button>
      <button class="nav-tab" onclick="showPage('profilo',this)">
        <span class="nav-icon">üë§</span><span class="nav-label">Profilo</span>
      </button>
    </div>
  </nav>

</div><!-- /mainApp -->


<!-- ============================================================
     MODALI
     ============================================================ -->

<!-- RICETTA DETTAGLIO -->
<div class="modal" id="recipeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="recipeModalTitle">Ricetta</h3>
      <button class="modal-close" onclick="closeRecipeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="recipeModalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeRecipeModal()">Chiudi</button>
      <button class="btn btn-primary"   onclick="applyRecipeToMeal()">‚úÖ Aggiungi al piano</button>
    </div>
  </div>
</div>

<!-- SALVA CONFIGURAZIONE FRIGO -->
<div class="modal" id="saveFridgeModal">
  <div class="modal-content modal-content-small">
    <div class="modal-header">
      <h3>üíæ Salva frigo</h3>
      <button class="modal-close" onclick="closeSaveFridgeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nome configurazione</label>
        <input type="text" id="fridgeName" class="form-input"
               placeholder="es. Spesa settimanale..."
               onkeypress="if(event.key==='Enter')saveFridge()">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSaveFridgeModal()">Annulla</button>
      <button class="btn btn-primary"   onclick="saveFridge()">üíæ Salva</button>
    </div>
  </div>
</div>

<!-- AGGIUNGI AL FRIGO (manuale) -->
<div class="modal" id="customIngModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Aggiungi al frigo</h3>
      <button class="modal-close" onclick="closeCustomIngModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Ingrediente <span style="color:var(--danger,#e05252)">*</span></label>
        <input type="text" id="customIngName" class="form-input"
               placeholder="es. Pollo, Salmone, Yogurt..."
               list="ingredientiDatalist"
               onkeypress="if(event.key==='Enter')document.getElementById('customIngQty').focus()">
      </div>
      <div class="form-group">
        <label>Categoria <span style="color:var(--danger,#e05252)">*</span></label>
        <select id="customIngCategory" class="form-input">
          <option value="">-- Seleziona categoria --</option>
          <option value="ü•© Carne e Pesce">ü•© Carne e Pesce</option>
          <option value="ü•õ Latticini e Uova">ü•õ Latticini e Uova</option>
          <option value="üåæ Cereali e Legumi">üåæ Cereali e Legumi</option>
          <option value="ü•¶ Verdure">ü•¶ Verdure</option>
          <option value="üçé Frutta">üçé Frutta</option>
          <option value="ü•ë Grassi e Condimenti">ü•ë Grassi e Condimenti</option>
          <option value="üç´ Dolci e Snack">üç´ Dolci e Snack</option>
          <option value="üßÇ Cucina">üßÇ Cucina</option>
        </select>
      </div>
      <div style="display:flex;gap:8px">
        <div class="form-group" style="flex:1">
          <label>Quantit√† iniziale</label>
          <input type="number" id="customIngQty" class="form-input"
                 placeholder="es. 200" min="0" step="any"
                 onkeypress="if(event.key==='Enter')addCustomIngredient()">
        </div>
        <div class="form-group" style="width:94px;flex:none">
          <label>Unit√†</label>
          <select id="customIngUnit" class="form-input">
            <option value="g">g</option>
            <option value="ml">ml</option>
            <option value="pz">pz</option>
            <option value="fette">fette</option>
            <option value="cucchiai">cucchiai</option>
            <option value="cucchiaini">cucchiaini</option>
            <option value="porzione">porzione</option>
            <option value="kg">kg</option>
            <option value="l">l</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCustomIngModal()">Annulla</button>
      <button class="btn btn-primary"   onclick="addCustomIngredient()">‚ûï Aggiungi</button>
    </div>
  </div>
</div>

<!-- EDITOR QUANTIT√Ä (tap sulla qty della card) -->
<div class="modal" id="qtyEditorModal">
  <div class="modal-content modal-content-small">
    <div class="modal-header">
      <h3 id="qtyEditorTitle">‚úèÔ∏è Modifica quantit√†</h3>
      <button class="modal-close" onclick="closeQtyEditor()">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:8px;align-items:center">
        <input type="number" id="qtyEditorValue" class="form-input"
               placeholder="Quantit√†" min="0" step="any" style="flex:1"
               onkeypress="if(event.key==='Enter')confirmQtyEditor()">
        <select id="qtyEditorUnit" class="form-input" style="width:90px;flex:none">
          <option value="g">g</option>
          <option value="ml">ml</option>
          <option value="pz">pz</option>
          <option value="fette">fette</option>
          <option value="cucchiai">cucchiai</option>
          <option value="cucchiaini">cucchiaini</option>
          <option value="porzione">porzione</option>
          <option value="kg">kg</option>
          <option value="l">l</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeQtyEditor()">Annulla</button>
      <button class="btn btn-primary"   onclick="confirmQtyEditor()">‚úÖ Conferma</button>
    </div>
  </div>
</div>

<!-- NUOVA / MODIFICA RICETTA -->
<div class="modal" id="ricettaFormModal">
  <div class="modal-content modal-content-large">
    <div class="modal-header">
      <h3 id="ricettaFormTitle">‚≠ê Nuova ricetta</h3>
      <button class="modal-close" onclick="closeRicettaForm()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nome <span style="color:var(--danger,#e05252)">*</span></label>
        <input type="text" id="rfNome" class="form-input" placeholder="es. Pasta al pesto...">
      </div>
      <div class="form-group">
        <label>Pasto ideale</label>
        <select id="rfPasto" class="form-input">
          <option value="colazione">‚òÄÔ∏è Colazione</option>
          <option value="spuntino">üçé Spuntino</option>
          <option value="pranzo" selected>üçΩ Pranzo</option>
          <option value="merenda">ü•™ Merenda</option>
          <option value="cena">üåô Cena</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ingredienti</label>
        <div id="rfIngList"></div>
        <button class="btn btn-secondary btn-small" style="margin-top:6px"
                onclick="addRfIngRow()">Ôºã Ingrediente</button>
      </div>
      <div class="form-group">
        <label>Preparazione</label>
        <textarea id="rfPrep" class="form-input form-textarea"
                  placeholder="Descrivi i passaggi..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeRicettaForm()">Annulla</button>
      <button class="btn btn-primary"   onclick="saveCustomRicetta()">üíæ Salva ricetta</button>
    </div>
  </div>
</div>

<!-- SPESA: QUANTIT√Ä ACQUISTATA -->
<div class="modal" id="spesaItemModal">
  <div class="modal-content modal-content-small">
    <div class="modal-header">
      <h3 id="spesaItemModalTitle">‚úÖ Quantit√† acquistata</h3>
      <button class="modal-close" onclick="closeSpesaItemModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="color:var(--text-mid);font-size:.87em;margin-bottom:16px;line-height:1.6">
        Inserisci la quantit√† acquistata per aggiornare il frigo automaticamente.
      </p>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="number" id="spesaItemQty" class="form-input"
               placeholder="Quantit√†" min="0" step="any" style="flex:1"
               onkeypress="if(event.key==='Enter')confirmSpesaQuantity()">
        <select id="spesaItemUnit" class="form-input" style="width:90px;flex:none">
          <option value="g">g</option>
          <option value="ml">ml</option>
          <option value="pz">pz</option>
          <option value="fette">fette</option>
          <option value="cucchiai">cucchiai</option>
          <option value="cucchiaini">cucchiaini</option>
          <option value="porzione">porzione</option>
          <option value="kg">kg</option>
          <option value="l">l</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSpesaItemModal()">Salta</button>
      <button class="btn btn-primary"   onclick="confirmSpesaQuantity()">‚úÖ Conferma</button>
    </div>
  </div>
</div>

<!-- iOS BANNER -->
<div class="ios-banner" id="iosBanner">
  <span style="font-size:1.3em">üì≤</span>
  <span style="flex:1;font-size:.82em;color:var(--text-mid)">
    Tocca <b>‚¨ÜÔ∏è Condividi</b> poi <b>"Aggiungi a schermata Home"</b>
  </span>
  <button class="btn btn-secondary btn-small" onclick="closeIosBanner()">‚úï</button>
</div>

<!-- PWA INSTALL BANNER (Android/Chrome) -->
<div class="install-banner" id="installBanner">
  <span>üì≤ Installa NutriPlan come app</span>
  <button class="btn btn-primary btn-small" id="installBtn">Installa</button>
  <button class="btn btn-secondary btn-small" id="dismissBtn">‚úï</button>
</div>

<!-- DATALIST AUTOCOMPLETE globale -->
<datalist id="ingredientiDatalist"></datalist>


<!-- ============================================================
     SCRIPTS ‚Äî ordine fondamentale
     ============================================================ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="data.js"></script>
<script src="storage.js"></script>
<script src="app.js"></script>
<script src="piano.js"></script>
<script src="dispensa.js"></script>
<script src="ricette.js"></script>
<script src="spesa.js"></script>
<script src="storico.js"></script>
<script src="profilo.js"></script>
<script src="firebase-config.js"></script>


<!-- ============================================================
     PATCH INLINE ‚Äî caricate DOPO tutti gli altri script
     ============================================================ -->
<script>

/* ‚îÄ‚îÄ updateAuthUI ‚îÄ‚îÄ */
function updateAuthUI(user) {
  var loginBtn   = document.getElementById('loginBtn');
  var logoutBtn  = document.getElementById('logoutBtn');
  var authPill   = document.getElementById('authUserPill');
  var authAvatar = document.getElementById('authAvatar');
  var authName   = document.getElementById('authName');
  if (user) {
    if (loginBtn)  loginBtn.style.display  = 'none';
    if (logoutBtn) logoutBtn.style.display = 'flex';
    if (authPill)  authPill.style.display  = 'flex';
    if (authAvatar && user.photoURL)    authAvatar.src         = user.photoURL;
    if (authName   && user.displayName) authName.textContent   = user.displayName.split(' ')[0];
  } else {
    if (loginBtn)  loginBtn.style.display  = 'flex';
    if (logoutBtn) logoutBtn.style.display = 'none';
    if (authPill)  authPill.style.display  = 'none';
    if (authAvatar) authAvatar.src         = '';
    if (authName)   authName.textContent   = '';
  }
}

/* ‚îÄ‚îÄ showCloudStatus ‚îÄ‚îÄ */
function showCloudStatus(status) {
  var el  = document.getElementById('cloudStatus');
  if (!el) return;
  var map = {
    local:  { cls: 'local',  text: 'üíæ Locale'          },
    saving: { cls: 'saving', text: '‚è≥ Salvataggio...'  },
    synced: { cls: 'synced', text: '‚òÅÔ∏è Sincronizzato'   },
    error:  { cls: 'error',  text: '‚ö†Ô∏è Errore sync'     }
  };
  var s = map[status] || map.local;
  el.className   = 'cloud-status ' + s.cls;
  el.textContent = s.text;
}

/* ‚îÄ‚îÄ checkOnlineStatus stub ‚îÄ‚îÄ */
function checkOnlineStatus() { showCloudStatus('local'); }

/* ‚îÄ‚îÄ initCalendar alias ‚îÄ‚îÄ */
function initCalendar() {
  if (typeof buildCalendarBar === 'function') buildCalendarBar();
}

/* ‚îÄ‚îÄ renderWeeklyLimits alias ‚îÄ‚îÄ */
function renderWeeklyLimits() {
  if (typeof updateLimits === 'function') updateLimits();
}

/* ‚îÄ‚îÄ resetWeek ‚îÄ‚îÄ */
function resetWeek() {
  if (!confirm('Resettare i contatori settimanali?')) return;
  if (typeof weeklyLimits !== 'undefined') {
    Object.keys(weeklyLimits).forEach(function(k) {
      if (weeklyLimits[k]) weeklyLimits[k].current = 0;
    });
  }
  if (typeof saveData === 'function') saveData();
  if (typeof updateLimits === 'function') updateLimits();
}

/* ‚îÄ‚îÄ clearPantrySearch ‚îÄ‚îÄ */
function clearPantrySearch() {
  var inp = document.getElementById('pantrySearch');
  if (inp) inp.value = '';
  if (typeof filterPantry === 'function') filterPantry('');
}

/* ‚îÄ‚îÄ initDayIngGrid ‚îÄ‚îÄ */
function initDayIngGrid() {
  if (typeof updateFridgeSuggestions === 'function') updateFridgeSuggestions();
  var el = document.getElementById('dayIngredientsGrid');
  if (!el) return;
  var allItems = (typeof getAllPantryItems === 'function') ? getAllPantryItems() : [];
  var active   = allItems.filter(function(i) { return (i.quantity || 0) > 0; });
  if (!active.length) {
    el.innerHTML =
      '<div class="empty-state"><div class="empty-state-icon">üõí</div>' +
      '<h3>Nessun ingrediente</h3>' +
      '<p>Aggiungi ingredienti al frigo o segna acquisti dalla spesa.</p></div>';
    return;
  }
  var html = '<div class="fridge-items" style="margin-top:8px">';
  active.forEach(function(item) {
    html += '<div class="fridge-item" style="pointer-events:none">' +
      '<div class="fridge-item-icon">' + (item.icon || 'üßÇ') + '</div>' +
      '<div class="fridge-item-name">'  + item.name + '</div>' +
      '<div class="fridge-item-qty">'   + item.quantity + ' ' + item.unit + '</div>' +
    '</div>';
  });
  html += '</div>';
  el.innerHTML = html;
}

/* ‚îÄ‚îÄ updateSavedFridges ‚îÄ‚îÄ */
function updateSavedFridges() {
  ['savedFridgesContent','savedFridgesContent2'].forEach(function(elId) {
    var el = document.getElementById(elId);
    if (!el) return;
    var keys = Object.keys(typeof savedFridges !== 'undefined' ? savedFridges : {});
    if (!keys.length) {
      el.innerHTML = '<p style="color:var(--text-light);font-size:.84em;margin-top:6px">Nessuna configurazione salvata.</p>';
      return;
    }
    el.innerHTML = keys.map(function(k) {
      var f  = savedFridges[k];
      var n  = Object.keys(f.items || {}).length;
      var sk = k.replace(/'/g, "\\'");
      return '<div class="saved-fridge-item">' +
        '<div class="saved-fridge-name">üìÅ ' + k + '</div>' +
        '<div class="saved-fridge-date">üïê ' + (f.date || '') + ' ¬∑ ' + n + ' ingredienti</div>' +
        '<div class="saved-fridge-actions">' +
          '<button class="btn btn-secondary btn-small" onclick="loadFridge(\'' + sk + '\')">üìÇ Carica</button>' +
          '<button class="btn btn-warning btn-small"   onclick="deleteFridge(\'' + sk + '\')">üóë</button>' +
        '</div></div>';
    }).join('');
  });
}

/* ‚îÄ‚îÄ showPage override: aggiorna anche sidebar ‚îÄ‚îÄ */
(function() {
  var _orig = window.showPage;
  if (typeof _orig !== 'function') return;
  window.showPage = function(name, btn) {
    _orig(name, btn);
    /* Sincronizza sidebar */
    document.querySelectorAll('.sidebar-nav .nav-tab').forEach(function(t) {
      t.classList.remove('active');
    });
    /* Trova il tasto sidebar corrispondente */
    var sidebarBtns = document.querySelectorAll('.sidebar-nav .nav-tab');
    sidebarBtns.forEach(function(b) {
      var onclick = b.getAttribute('onclick') || '';
      if (onclick.indexOf("'" + name + "'") !== -1) b.classList.add('active');
    });
    /* render extra */
    if (name === 'dispensa') {
      if (typeof renderFridge === 'function') renderFridge();
      updateSavedFridges();
    }
    if (name === 'statistiche' && typeof renderStatistiche === 'function') renderStatistiche();
  };
})();

/* ‚îÄ‚îÄ Stats stub (stats.js non esiste) ‚îÄ‚îÄ */
function renderStatistiche() {
  var el = document.getElementById('statsContent');
  if (!el) return;
  var totalDays = Object.keys(typeof appHistory !== 'undefined' ? appHistory : {})
    .filter(function(dk) {
      var hd = appHistory[dk];
      if (!hd || !hd.usedItems) return false;
      return Object.keys(hd.usedItems).some(function(mk) {
        return Object.keys(hd.usedItems[mk] || {}).length > 0;
      });
    }).length;
  var allMeals = ['colazione','spuntino','pranzo','merenda','cena'];
  var totalUsed = 0;
  Object.keys(typeof appHistory !== 'undefined' ? appHistory : {}).forEach(function(dk) {
    var ui = (appHistory[dk] || {}).usedItems || {};
    allMeals.forEach(function(mk) { totalUsed += Object.keys(ui[mk] || {}).length; });
  });
  var pantryCount = Object.keys(typeof pantryItems !== 'undefined' ? pantryItems : {})
    .filter(function(k) { return k && k !== 'undefined' && ((pantryItems[k] || {}).quantity || 0) > 0; }).length;
  el.innerHTML =
    '<div class="stats-grid">' +
      '<div class="stat-card"><div class="stat-card-icon">üìÖ</div><div class="stat-card-value">' + totalDays + '</div><div class="stat-card-label">Giorni tracciati</div></div>' +
      '<div class="stat-card"><div class="stat-card-icon">‚úÖ</div><div class="stat-card-value">' + totalUsed + '</div><div class="stat-card-label">Alimenti consumati</div></div>' +
      '<div class="stat-card"><div class="stat-card-icon">‚ùÑÔ∏è</div><div class="stat-card-value">' + pantryCount + '</div><div class="stat-card-label">Nel frigo ora</div></div>' +
      '<div class="stat-card"><div class="stat-card-icon">üìñ</div><div class="stat-card-value">' + ((typeof customRecipes !== 'undefined' ? customRecipes : []).length) + '</div><div class="stat-card-label">Ricette personali</div></div>' +
    '</div>';
}

/* ‚îÄ‚îÄ Ricetta form CRUD ‚îÄ‚îÄ */
var _rfEditIdx = null;

function openRicettaForm(idx) {
  _rfEditIdx = (idx !== undefined) ? idx : null;
  var titleEl = document.getElementById('ricettaFormTitle');
  var nomeEl  = document.getElementById('rfNome');
  var pastoEl = document.getElementById('rfPasto');
  var prepEl  = document.getElementById('rfPrep');
  var ingList = document.getElementById('rfIngList');
  if (!nomeEl) return;
  var customs = typeof customRecipes !== 'undefined' ? customRecipes : [];
  if (_rfEditIdx !== null && customs[_rfEditIdx]) {
    var r = customs[_rfEditIdx];
    if (titleEl) titleEl.textContent = '‚úèÔ∏è Modifica ricetta';
    nomeEl.value  = r.name || '';
    pastoEl.value = Array.isArray(r.pasto) ? r.pasto[0] : (r.pasto || 'pranzo');
    prepEl.value  = r.preparazione || '';
    ingList.innerHTML = '';
    (r.ingredienti || []).forEach(function(ing) { addRfIngRow(ing); });
  } else {
    if (titleEl) titleEl.textContent = '‚≠ê Nuova ricetta';
    nomeEl.value  = '';
    pastoEl.value = 'pranzo';
    prepEl.value  = '';
    ingList.innerHTML = '';
    addRfIngRow();
  }
  var m = document.getElementById('ricettaFormModal');
  if (m) { m.classList.add('active'); setTimeout(function() { nomeEl.focus(); }, 80); }
}

function closeRicettaForm() {
  var m = document.getElementById('ricettaFormModal');
  if (m) m.classList.remove('active');
  _rfEditIdx = null;
}

function addRfIngRow(ing) {
  ing = ing || {};
  var list = document.getElementById('rfIngList');
  if (!list) return;
  var units = ['g','ml','pz','fette','cucchiai','cucchiaini','porzione','kg','l'];
  var unitOpts = units.map(function(u) {
    return '<option value="' + u + '"' + ((ing.unit || 'g') === u ? ' selected' : '') + '>' + u + '</option>';
  }).join('');
  var row = document.createElement('div');
  row.className = 'rf-ing-row';
  row.innerHTML =
    '<input type="text"   class="form-input rf-ing-name" value="' + (ing.name || '') + '" placeholder="Ingrediente..." list="ingredientiDatalist">' +
    '<input type="number" class="form-input rf-ing-qty"  value="' + (ing.quantity || '') + '" placeholder="Qt√†" min="0" step="any">' +
    '<select class="form-input rf-ing-unit">' + unitOpts + '</select>' +
    '<button style="width:30px;height:30px;border:1.5px solid var(--border);border-radius:var(--radius-xs);background:var(--bg-light);cursor:pointer;color:var(--danger,#e05252);font-size:.9em" ' +
            'onclick="this.closest(\'.rf-ing-row\').remove()">‚úï</button>';
  list.appendChild(row);
}

function saveCustomRicetta() {
  var nome = (document.getElementById('rfNome').value || '').trim();
  if (!nome) { alert('Inserisci il nome della ricetta.'); return; }
  var pasto = document.getElementById('rfPasto').value;
  var prep  = (document.getElementById('rfPrep').value || '').trim();
  var ings  = [];
  document.querySelectorAll('#rfIngList .rf-ing-row').forEach(function(row) {
    var n = (row.querySelector('.rf-ing-name').value || '').trim();
    var q = parseFloat(row.querySelector('.rf-ing-qty').value) || null;
    var u = row.querySelector('.rf-ing-unit').value || 'g';
    if (n) ings.push({ name: n, quantity: q, unit: u });
  });
  var ricetta = { name: nome, icon: 'üçΩ', pasto: pasto, ingredienti: ings, preparazione: prep, isCustom: true };
  if (typeof customRecipes === 'undefined') customRecipes = [];
  if (_rfEditIdx !== null && customRecipes[_rfEditIdx]) {
    customRecipes[_rfEditIdx] = ricetta;
  } else {
    customRecipes.push(ricetta);
  }
  if (typeof saveData === 'function') saveData();
  closeRicettaForm();
  if (typeof renderCustomRicette === 'function') renderCustomRicette();
}

function editCustomRicetta(idx)   { openRicettaForm(idx); }
function deleteCustomRicetta(idx) {
  if (!confirm('Eliminare questa ricetta?')) return;
  customRecipes.splice(idx, 1);
  if (typeof saveData === 'function') saveData();
  if (typeof renderCustomRicette === 'function') renderCustomRicette();
}

/* ‚îÄ‚îÄ Chiusura modale cliccando fuori ‚îÄ‚îÄ */
document.addEventListener('click', function(e) {
  ['recipeModal','saveFridgeModal','customIngModal','qtyEditorModal',
   'ricettaFormModal','spesaItemModal'].forEach(function(id) {
    var m = document.getElementById(id);
    if (m && m.classList.contains('active') && e.target === m) m.classList.remove('active');
  });
});

/* ‚îÄ‚îÄ Canvas logo ‚îÄ‚îÄ */
function drawLogo(id, size) {
  var c = document.getElementById(id);
  if (!c) return;
  c.width = size; c.height = size;
  var ctx = c.getContext('2d');
  var g   = ctx.createLinearGradient(0, 0, size, size);
  g.addColorStop(0, '#4caf85'); g.addColorStop(1, '#2a6350');
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.font = 'bold ' + Math.round(size * 0.46) + 'px Poppins,sans-serif';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('N', size / 2, size / 2);
}
document.addEventListener('DOMContentLoaded', function() {
  drawLogo('headerIcon', 32);
  if (typeof initIngredientiDatalist === 'function') initIngredientiDatalist();
});

</script>
</body>
</html>
